{% extends "base.html" %}

{% block title %}Ôn tập{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="/vocabulary" class="btn btn-light border rounded-pill px-3 fw-bold hover-scale shadow-sm">
            <i class="fas fa-chevron-left me-2"></i> Quay lại
        </a>
        <h4 class="fw-bold text-dark m-0">Ôn tập từ vựng</h4>
        <div style="width: 100px;"></div>
    </div>

    <!-- TRƯỜNG HỢP 1: KHÔNG CÓ TỪ NÀO CẦN ÔN -->
    {% if not cards %}
    <div class="text-center py-5 animate-fade-in">
        <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-4 mb-3 shadow-sm animate-bounce">
            <i class="fas fa-check-circle text-success" style="font-size: 60px;"></i>
        </div>
        <h3 class="fw-bold text-dark mb-2">Tuyệt vời!</h3>
        <p class="text-muted fs-6 mb-4">Bạn đã hoàn thành tất cả bài ôn tập hôm nay.</p>
        <a href="/vocabulary" class="btn btn-primary rounded-pill px-5 fw-bold shadow hover-scale">
            Học thêm từ mới
        </a>
    </div>
    {% else %}

    <!-- TRƯỜNG HỢP 2: GAME ĐOÁN CHỮ (GIAO DIỆN TRẮNG SẠCH) -->
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            
            <!-- CARD CHÍNH -->
            <div class="card bg-white border-0 shadow-lg rounded-4 overflow-hidden position-relative main-card">
                
                <!-- Badge góc phải -->
                <div class="position-absolute top-0 end-0 m-3 z-1">
                    <span class="badge bg-light text-secondary border rounded-pill px-3 py-1 fw-bold small">
                        Đã ôn <span id="reviewCount" class="text-dark">1</span>
                    </span>
                </div>

                <!-- (ĐÃ XÓA HÌNH TRANG TRÍ MẢNH GHÉP Ở ĐÂY) -->

                <div class="card-body p-4 text-center d-flex flex-column justify-content-center" style="min-height: 450px;">
                    
                    <!-- 1. ẢNH & THÔNG TIN CƠ BẢN -->
                    <div class="mb-3">
                        <img id="qzImage" src="" class="rounded-3 shadow-sm border" width="80" height="80" style="object-fit: cover;">
                    </div>

                    <div class="mb-2">
                        <h3 class="fw-bold text-primary mb-1" id="qzMeaning">...</h3>
                        <span class="badge bg-light text-secondary border px-2 py-1" id="qzType" style="font-size: 0.75rem;">...</span>
                    </div>

                    <!-- 2. GỢI Ý (ĐỊNH NGHĨA & VÍ DỤ) -->
                    <div class="bg-light rounded-3 p-3 mb-3 mx-auto w-100 text-start border border-light shadow-sm" style="max-width: 450px;">
                        <div class="d-flex gap-2 align-items-start mb-2">
                            <i class="fas fa-info-circle text-info mt-1"></i>
                            <div>
                                <small class="text-muted fw-bold d-block" style="font-size: 0.7rem;">ĐỊNH NGHĨA:</small>
                                <span class="text-dark small" id="qzDefEn" style="line-height: 1.3;">...</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2 align-items-start">
                            <i class="fas fa-quote-left text-warning mt-1"></i>
                            <div>
                                <small class="text-muted fw-bold d-block" style="font-size: 0.7rem;">VÍ DỤ:</small>
                                <span class="text-dark small fst-italic" id="qzExample" style="line-height: 1.3;">...</span>
                                <div class="text-muted smaller mt-1" id="qzExampleVi" style="font-size: 0.75rem;">...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Ô NHẬP LIỆU & GỢI Ý -->
                    <div class="position-relative mb-3 mx-auto w-100" style="max-width: 350px;">
                        <!-- Placeholder gạch chân -->
                        <div id="wordPlaceholder" class="d-flex justify-content-center gap-1 mb-2 font-monospace text-primary fw-bold" style="height: 24px; font-size: 1.2rem;"></div>

                        <input type="text" id="qzInput" class="form-control form-control-lg bg-white text-dark text-center fw-bold py-2 rounded-3 border shadow-sm" 
                               placeholder="NHẬP ĐÁP ÁN..." autocomplete="off" style="letter-spacing: 1px; font-size: 1.1rem;">
                        
                        <!-- Nút Gợi ý nhỏ gọn -->
                        <button id="btnHint" class="btn btn-warning position-absolute top-50 end-0 translate-middle-y me-1 fw-bold px-2 py-1 rounded-3 shadow-sm hover-scale small-btn" 
                                onclick="showRandomHint()">
                            <i class="far fa-lightbulb"></i> <span id="hintCount">3</span>
                        </button>
                    </div>

                    <!-- Thông báo kết quả -->
                    <div id="qzResult" class="alert d-none fw-bold p-2 mb-3 rounded-3 shadow-sm animate-fade-in mx-auto small" style="max-width: 350px;"></div>

                    <!-- 4. NÚT HÀNH ĐỘNG -->
                    <div class="row g-2 justify-content-center">
                        <div class="col-5 col-md-4">
                            <button class="btn btn-outline-danger w-100 py-2 fw-bold rounded-3 hover-scale shadow-sm" onclick="checkAnswer(false)">
                                <i class="far fa-eye me-1"></i> Đáp án
                            </button>
                        </div>
                        <div class="col-7 col-md-5">
                            <button class="btn btn-primary w-100 py-2 fw-bold rounded-3 hover-scale shadow-sm" onclick="checkAnswer(true)">
                                Kiểm tra <i class="fas fa-check ms-1"></i>
                            </button>
                        </div>
                    </div>

                </div>
                
                <!-- Thanh tiến độ dưới đáy -->
                <div class="card-footer bg-white border-top pt-3 pb-3">
                    <div class="row g-0 text-center small opacity-75">
                        <div class="col-4 border-end">
                            <div class="text-warning fw-bold" id="statRemaining">0</div>
                            <div class="text-muted smaller">Còn lại</div>
                        </div>
                        <div class="col-4 border-end">
                            <div class="text-success fw-bold" id="statCompleted">0</div>
                            <div class="text-muted smaller">Xong</div>
                        </div>
                        <div class="col-4">
                            <div class="text-primary fw-bold" id="statTotal">0</div>
                            <div class="text-muted smaller">Tổng</div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
    {% endif %}
</div>

<!-- JAVASCRIPT LOGIC -->
{% if cards %}
<script>
    const cards = {{ cards | tojson }};
    let currentIdx = 0;
    let hintsLeft = 3;
    let revealedIndices = [];
    let completedCount = 0;

    function updateStats() {
        document.getElementById('statTotal').innerText = cards.length;
        document.getElementById('statCompleted').innerText = completedCount;
        document.getElementById('statRemaining').innerText = cards.length - completedCount;
    }

    function loadQuiz(idx) {
        if (idx >= cards.length) {
            document.querySelector('.row.justify-content-center').innerHTML = `
                <div class="text-center py-5 animate-fade-in">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-4 mb-3 shadow-sm animate-bounce">
                        <i class="fas fa-check-circle text-success" style="font-size: 60px;"></i>
                    </div>
                    <h3 class="fw-bold text-dark mb-2">Xuất sắc!</h3>
                    <p class="text-muted mb-4">Bạn đã hoàn thành phiên ôn tập.</p>
                    <a href="/vocabulary" class="btn btn-primary rounded-pill px-5 fw-bold shadow hover-scale">
                        Về danh sách
                    </a>
                </div>
            `;
            return;
        }

        const card = cards[idx];
        document.getElementById('qzImage').src = card.image;
        document.getElementById('qzMeaning').innerText = card.meaning;
        document.getElementById('qzType').innerText = card.type;
        
        document.getElementById('qzDefEn').innerText = card.def_en;
        
        const hiddenWord = "<span class='text-primary fw-bold'>______</span>";
        const exEnMasked = card.example_en.replace(new RegExp(card.word, 'gi'), hiddenWord);
        document.getElementById('qzExample').innerHTML = exEnMasked;
        document.getElementById('qzExampleVi').innerText = card.example_vi;

        const inp = document.getElementById('qzInput');
        inp.value = '';
        inp.classList.remove('is-valid', 'is-invalid');
        document.getElementById('qzResult').classList.add('d-none');
        
        hintsLeft = 3;
        revealedIndices = [];
        updateHintButton();
        renderPlaceholder();
        updateStats();
    }

    function renderPlaceholder() {
        const word = cards[currentIdx].word;
        const container = document.getElementById('wordPlaceholder');
        container.innerHTML = ''; 
        
        for(let i=0; i<word.length; i++) {
            const span = document.createElement('span');
            span.innerText = word[i] === ' ' ? ' ' : '_';
            span.className = 'd-inline-block text-center mx-1';
            span.style.width = '12px';
            
            if (revealedIndices.includes(i)) {
                span.innerText = word[i].toUpperCase();
                span.classList.add('text-warning');
                span.style.borderBottom = 'none';
            } else if (word[i] !== ' ') {
                 span.style.borderBottom = '2px solid #cbd5e1'; 
            }
            container.appendChild(span);
        }
    }

    function updateHintButton() {
        const btn = document.getElementById('btnHint');
        if (hintsLeft <= 0) {
            btn.disabled = true;
            btn.classList.add('opacity-50');
            btn.innerHTML = `<i class="fas fa-lock"></i>`;
        } else {
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            btn.innerHTML = `<i class="far fa-lightbulb"></i> ${hintsLeft}`;
        }
    }

    function showRandomHint() {
        if (hintsLeft <= 0) return;

        const word = cards[currentIdx].word;
        const inp = document.getElementById('qzInput');
        let currentVal = inp.value;
        
        let targetIndex = -1;
        for (let i = 0; i < word.length; i++) {
            if (currentVal.length <= i || currentVal[i].toLowerCase() !== word[i].toLowerCase()) {
                targetIndex = i;
                break;
            }
        }

        if (targetIndex === -1) {
             if (currentVal.length < word.length) targetIndex = currentVal.length;
             else return;
        }

        const correctPart = word.substring(0, targetIndex);
        const hintChar = word[targetIndex];
        inp.value = correctPart + hintChar;
        
        if (!revealedIndices.includes(targetIndex)) {
             revealedIndices.push(targetIndex);
             renderPlaceholder();
        }

        hintsLeft--;
        updateHintButton();
        inp.focus();
    }

    function checkAnswer(isSubmit) {
        const inp = document.getElementById('qzInput');
        const resBox = document.getElementById('qzResult');
        const correct = cards[currentIdx].word.toLowerCase();

        if (!isSubmit) {
            inp.value = cards[currentIdx].word;
            resBox.className = "alert alert-warning p-2 mb-3 rounded-3 small";
            resBox.innerHTML = `Đáp án: <strong class="text-dark">${cards[currentIdx].word}</strong>`;
            resBox.classList.remove('d-none');
            rateReviewCard('hoc-lai');
            setTimeout(() => { completedCount++; currentIdx++; loadQuiz(currentIdx); }, 2000);
            return;
        }

        const userVal = inp.value.trim().toLowerCase();
        if (userVal === correct) {
            inp.classList.add('is-valid');
            resBox.className = "alert alert-success p-2 mb-3 rounded-3 small";
            resBox.innerHTML = `<i class="fas fa-check-circle me-1"></i>Chính xác!`;
            resBox.classList.remove('d-none');
            rateReviewCard('tot');
            setTimeout(() => { completedCount++; currentIdx++; loadQuiz(currentIdx); }, 1000);
        } else {
            inp.classList.add('is-invalid');
            resBox.className = "alert alert-danger p-2 mb-3 rounded-3 small";
            resBox.innerText = "Chưa đúng!";
            resBox.classList.remove('d-none');
        }
    }

    function rateReviewCard(rating) {
        const cardId = cards[currentIdx].id;
        fetch('/save_progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ card_id: cardId, rating: rating })
        });
    }

    updateStats();
    loadQuiz(0);
</script>
{% endif %}

<style>
    /* CSS Light Mode */
    .text-primary { color: #0d6efd !important; }
    .text-info { color: #0dcaf0 !important; }
    
    #qzInput {
        background-color: #fff;
        border: 2px solid #dee2e6;
        color: #212529;
        font-size: 1.1rem;
    }
    #qzInput:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .small-btn { font-size: 0.8rem; padding: 4px 10px; }
    .hover-scale { transition: transform 0.2s; }
    .hover-scale:hover { transform: scale(1.03); }
    
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .animate-bounce { animation: bounce 2s infinite; }
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-10px);}
        60% {transform: translateY(-5px);}
    }
    
    .pointer-events-none { pointer-events: none; }
    .smaller { font-size: 0.75rem; }
</style>
{% endblock %}